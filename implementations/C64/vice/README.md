# VICE Debugger Integration Documentation

This folder contains documentation for VICE emulator debugger integration for the PyCo VS Code extension.

## Table of Contents

| Document                                                          | Description                                |
|-------------------------------------------------------------------|--------------------------------------------|
| [vice_binary_protocol.md](vice_binary_protocol.md)                | VICE binary monitor protocol               |
| [vice_text_monitor.md](vice_text_monitor.md)                      | VICE text monitor commands                 |
| [debug_adapter_design.md](debug_adapter_design.md)                | PyCo debugger design document              |
| [reference_implementations.md](reference_implementations.md)      | Lessons from existing debugger implementations |

## Quick Overview

### What is needed for the debugger to work?

1. **VICE 3.5+** - The binary monitor protocol is available from 3.5
2. **Binary monitor enabled** - `-binarymonitor` flag
3. **Debug info** - Source ↔ address mapping (generated by compiler)

### Starting VICE in debug mode

```bash
# Default port (6502)
x64sc -binarymonitor program.prg

# Custom port
x64sc -binarymonitor -binarymonitoraddress 127.0.0.1:6502 program.prg

# In warp mode (faster)
x64sc -binarymonitor -warp program.prg
```

### Debug workflow

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   VS Code    │────▶│ Debug Adapter│────▶│    VICE      │
│  Breakpoint  │     │  (TCP 6502)  │     │  Emulator    │
└──────────────┘     └──────────────┘     └──────────────┘
       │                    │                    │
       │  1. Set BP at      │                    │
       │     line 10        │                    │
       │  ──────────────▶   │                    │
       │                    │  2. Checkpoint     │
       │                    │     Set $0820      │
       │                    │  ──────────────▶   │
       │                    │                    │
       │                    │  3. Stopped        │
       │                    │     (event)        │
       │                    │  ◀──────────────   │
       │  4. Show BP hit    │                    │
       │     at line 10     │                    │
       │  ◀──────────────   │                    │
```

## Key Protocol Elements

### Command Types (most important)

| Code   | Command               | Debugger Function             |
|--------|-----------------------|-------------------------------|
| 0x12   | Checkpoint Set        | Setting breakpoints           |
| 0x13   | Checkpoint Delete     | Deleting breakpoints          |
| 0x71   | Advance Instructions  | Step into / Step over         |
| 0xAA   | Exit                  | Continue (F5)                 |
| 0x31   | Registers Get         | Getting CPU registers         |
| 0x01   | Memory Get            | Reading variable values       |

### Event Types

| Code   | Event       | Meaning                               |
|--------|-------------|---------------------------------------|
| 0x62   | Stopped     | Breakpoint hit / step complete        |
| 0x63   | Resumed     | Execution resumed                     |
| 0x61   | JAM         | Illegal opcode                        |

## Debug Info Generation (TODO)

The compiler needs to generate:

1. **JSON debug info** (`program.pyco.debug`)
   - Source line → assembly address mapping
   - Variable definitions (address, type, scope)
   - Function boundaries (stack frame info)

2. **VICE label file** (`program.vs`)
   - `al C:080d .__F_main` format
   - Automatically loaded with the PRG

## References

### Official Documentation

- [VICE Manual - Binary Monitor](https://vice-emu.sourceforge.io/vice_13.html)
- [VICE Manual - Monitor Commands](https://vice-emu.sourceforge.io/vice_12.html)
- [VS Code Debug Adapter Protocol](https://microsoft.github.io/debug-adapter-protocol/)

### Existing Implementations (for learning)

- **[VS64](https://github.com/rolandshacks/vs64)** - TypeScript, full C64 dev env
- **[vscode-cc65-vice-debug](https://github.com/empathicqubit/vscode-cc65-vice-debug)** - CC65 debugger
- **[IceBro Lite](https://github.com/Sakrac/IceBroLite)** - C++, standalone debugger

### Useful Resources

- [c64jasm debug info](https://nurpax.github.io/posts/2021-02-22-c64jasm-debug-info.html) - Source mapping concept
- [cc65 debugging guide](https://cc65.github.io/doc/debugging.html) - VICE label format
